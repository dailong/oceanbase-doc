# 新增一个 case

本文介绍如何新增 case 和 case 示例说明。

## 操作步骤

在通用的 t 目录下:

假设我们测试 create table like 这个功能，case 文件最好能反映测试点，比如create_table_like_syntax.test 为语法级别的测试。

1. 进入文件目录：

    ```bash
    cd oceanbase/tools/deploy/
    ```

2. 输入 case 文件的内容：

    ```bash
    vi mysqltest/t/sample.test
    ```

3. 生产结果文件：

    ```bash
    ./deploy.py ob1.mysqltest testset=sample record
    ```

4. 人工校验结果文件后（这步也可能通过执行与 MySQL 的对比来完成）:

    ```bash
    mv mysqltest/record/sample.record mysqltest/r/sample.result
    ```

    与 MySQL 对比的命令：

    ```bash
    ./deploy.py ob1.mysqltest testset=sample mysql=ip:port
    ```

    此时 MySQL 的文件生成在 `mysql_test/r/sample.result.my`，如果 MySQL 的结果文件可以直接作为结果文件，可以直接执行 `mv sample.result.my sample.result`。

5. 再运行检查一遍：

    ```bash
    ./deploy.py ob1.mysqltest testset=sample 
    ```

6. 提交时注意 git add 的时候要同时提交 test 文件和 result 文件。

## 示例

`stddev_series.test` 主要目的是测试方差相关聚合函数，包括 stddev、stddev_pop、stddev_samp、variance，其中井号（#）开头的行内容为备注说明。

### case 文件

```sql
--disable_warnings
drop database if exists austin;
--enable_warnings
create database austin;
use austin;

#basic test
create table t1 (v1 int);
insert into t1 values(1);
insert into t1 values(2);
insert into t1 values(3);
insert into t1 values(4);
insert into t1 values(9);

explain select std(v1) from t1;
explain select stddev(v1) from t1;
explain select stddev_samp(v1) from t1;
explain select stddev_pop(v1) from t1;
explain select variance(v1) from t1;

select std(v1) from t1;
select stddev(v1) from t1;
select stddev_samp(v1) from t1;
select stddev_pop(v1) from t1;
select variance(v1) from t1;

create table t_std as select std(v1) V from t1;
create table t_stddev as select stddev(v1) V from t1;
create table t_stddev_pop as select stddev_pop(v1) V from t1;
create table t_variance as select variance(v1) V from t1;
create table t_stddev_samp as select stddev_samp(v1) V from t1;
desc t_std;
desc t_stddev;
desc t_stddev_pop;
desc t_variance;
desc t_stddev_samp;

#co test
create table t2(v1 int, v2 decimal(31,8), v3 double);
insert into t2 values(1,2.3,3.5),(2,3.2,4.7),(123,123.578,0.002);
insert into t2 values(1.22,2.98,3.5),(2.1,3.7,4.9),(173,113.558,0.001);
select std(v1), stddev(v1),stddev(v2),stddev(v3) from t2;
select stddev_samp(v1),stddev_samp(v2),stddev_samp(v3) from t2;
select stddev_pop(v1),stddev_pop(v2),stddev_pop(v3) from t2;
select variance(v1),variance(v2),variance(v3) from t2;

#corner case
select std(1) from dual;
select stddev(1) from dual;
select stddev_pop(1) from dual;
select stddev_samp(-1) from dual;
select variance(-10) from dual;
create table t3(v1 int);
insert into t3 values(0);

#测试分布式场景
create table t_distribute(v1 int, v2 double, v3 decimal(20,7)) partition by hash(v1) partitions 4;
insert into t_distribute values(1, 2.111111111, 1233.3344444);
insert into t_distribute values(2, 2777.12, 3.3341242314444);
insert into t_distribute values(3, 55.112, 3.3343544444);
insert into t_distribute values(4, 233.3312, 3243.3344444);
insert into t_distribute values(5, 177.7712, 3.3899344444);
insert into t_distribute values(6, 999.1992, 7893.378143344444);
insert into t_distribute values(7, 277.7712, 156543.763344444);
insert into t_distribute values(8, 244.1992, 4643.4643344444);
insert into t_distribute values(9, 612.162, 46463.3446344444);
insert into t_distribute values(10, 223.312, 4643.34646344444);
insert into t_distribute values(11, 12.12, 79793.798793344444);

explain select stddev(v1) from t_distribute;
select std(v1), stddev(v1),stddev(v2),stddev(v3) from t_distribute;
select stddev_samp(v1),stddev_samp(v2),stddev_samp(v3) from t_distribute;
select stddev_pop(v1),stddev_pop(v2),stddev_pop(v3) from t_distribute;
select variance(v1),variance(v2),variance(v3) from t_distribute;

#测试distinct场景
create table t_distinct(v1 int);
insert into t_distinct values(9);
insert into t_distinct values(10);
insert into t_distinct values(10);
insert into t_distinct values(10);
insert into t_distinct values(11);
insert into t_distinct values(12);
## explain select stddev(distinct v1) from t_distribute;
## select variance(distinct v1), variance(v1) from t_distinct;
## select stddev(distinct v1), stddev(v1) from t_distinct;

## select stddev_samp(distinct v1), stddev_samp(v1) from t_distinct;
select stddev_samp(v1), stddev_samp(v1) from t_distinct;

##select stddev_pop(distinct v1), stddev_pop(v1) from t_distinct;
select stddev_pop(v1), stddev_pop(v1) from t_distinct;

####只有一行数据时求方差
select std(v1) from t3;
select stddev(v1) from t3;
select stddev_samp(v1) from t3;
select stddev_pop(v1) from t3;
select variance(v1) from t3;
```

### 预期结果文件

```result
drop database if exists austin;
create database austin;
use austin;
create table t1 (v1 int);
insert into t1 values(1);
insert into t1 values(2);
insert into t1 values(3);
insert into t1 values(4);
insert into t1 values(9);
explain select std(v1) from t1;
Query Plan
========================================
|ID|OPERATOR       |NAME|EST. ROWS|COST|
----------------------------------------
|0 |SCALAR GROUP BY|    |1        |47  |
|1 | TABLE SCAN    |t1  |5        |46  |
========================================

Outputs & filters: 
-------------------------------------
  0 - output([sqrt(cast(cast(T_FUN_SUM(t1.v1 * t1.v1), DECIMAL(65, 30)) / cast(T_FUN_COUNT(t1.v1 * t1.v1), DECIMAL(20, 0)) - cast(T_FUN_SUM(t1.v1), DECIMAL(65, 30)) * cast(T_FUN_SUM(t1.v1), DECIMAL(65, 30)) / cast(T_FUN_COUNT(t1.v1) * T_FUN_COUNT(t1.v1), DECIMAL(40, 0)), DOUBLE(-1, -1)))]), filter(nil), 
      group(nil), agg_func([T_FUN_SUM(t1.v1)], [T_FUN_SUM(t1.v1 * t1.v1)], [T_FUN_COUNT(t1.v1)], [T_FUN_COUNT(t1.v1 * t1.v1)])
  1 - output([t1.v1]), filter(nil), 
      access([t1.v1]), partitions(p0)

explain select stddev(v1) from t1;
Query Plan
========================================
|ID|OPERATOR       |NAME|EST. ROWS|COST|
----------------------------------------
|0 |SCALAR GROUP BY|    |1        |47  |
|1 | TABLE SCAN    |t1  |5        |46  |
========================================

Outputs & filters: 
-------------------------------------
  0 - output([sqrt(cast(cast(T_FUN_SUM(t1.v1 * t1.v1), DECIMAL(65, 30)) / cast(T_FUN_COUNT(t1.v1 * t1.v1), DECIMAL(20, 0)) - cast(T_FUN_SUM(t1.v1), DECIMAL(65, 30)) * cast(T_FUN_SUM(t1.v1), DECIMAL(65, 30)) / cast(T_FUN_COUNT(t1.v1) * T_FUN_COUNT(t1.v1), DECIMAL(40, 0)), DOUBLE(-1, -1)))]), filter(nil), 
      group(nil), agg_func([T_FUN_SUM(t1.v1)], [T_FUN_SUM(t1.v1 * t1.v1)], [T_FUN_COUNT(t1.v1)], [T_FUN_COUNT(t1.v1 * t1.v1)])
  1 - output([t1.v1]), filter(nil), 
      access([t1.v1]), partitions(p0)

explain select stddev_samp(v1) from t1;
Query Plan
========================================
|ID|OPERATOR       |NAME|EST. ROWS|COST|
----------------------------------------
|0 |SCALAR GROUP BY|    |1        |47  |
|1 | TABLE SCAN    |t1  |5        |46  |
========================================

Outputs & filters: 
-------------------------------------
  0 - output([sqrt(cast(cast(T_FUN_SUM(t1.v1 * t1.v1), DECIMAL(65, 30)) - cast(T_FUN_SUM(t1.v1), DECIMAL(65, 30)) * cast(T_FUN_SUM(t1.v1), DECIMAL(65, 30)) / cast(T_FUN_COUNT(t1.v1), DECIMAL(20, 0)) / cast(CASE WHEN T_FUN_COUNT(t1.v1) - 1 != 0 THEN T_FUN_COUNT(t1.v1) - 1 ELSE NULL END, DECIMAL(20, 0)), DOUBLE(-1, 36)))]), filter(nil), 
      group(nil), agg_func([T_FUN_SUM(t1.v1)], [T_FUN_SUM(t1.v1 * t1.v1)], [T_FUN_COUNT(t1.v1)])
  1 - output([t1.v1]), filter(nil), 
      access([t1.v1]), partitions(p0)

explain select stddev_pop(v1) from t1;
Query Plan
========================================
|ID|OPERATOR       |NAME|EST. ROWS|COST|
----------------------------------------
|0 |SCALAR GROUP BY|    |1        |47  |
|1 | TABLE SCAN    |t1  |5        |46  |
========================================

Outputs & filters: 
-------------------------------------
  0 - output([sqrt(cast(cast(T_FUN_SUM(t1.v1 * t1.v1), DECIMAL(65, 30)) / cast(T_FUN_COUNT(t1.v1 * t1.v1), DECIMAL(20, 0)) - cast(T_FUN_SUM(t1.v1), DECIMAL(65, 30)) * cast(T_FUN_SUM(t1.v1), DECIMAL(65, 30)) / cast(T_FUN_COUNT(t1.v1) * T_FUN_COUNT(t1.v1), DECIMAL(40, 0)), DOUBLE(-1, -1)))]), filter(nil), 
      group(nil), agg_func([T_FUN_SUM(t1.v1)], [T_FUN_SUM(t1.v1 * t1.v1)], [T_FUN_COUNT(t1.v1)], [T_FUN_COUNT(t1.v1 * t1.v1)])
  1 - output([t1.v1]), filter(nil), 
      access([t1.v1]), partitions(p0)

explain select variance(v1) from t1;
Query Plan
========================================
|ID|OPERATOR       |NAME|EST. ROWS|COST|
----------------------------------------
|0 |SCALAR GROUP BY|    |1        |47  |
|1 | TABLE SCAN    |t1  |5        |46  |
========================================

Outputs & filters: 
-------------------------------------
  0 - output([cast(cast(T_FUN_SUM(t1.v1 * t1.v1), DECIMAL(65, 30)) / cast(T_FUN_COUNT(t1.v1 * t1.v1), DECIMAL(20, 0)) - cast(T_FUN_SUM(t1.v1), DECIMAL(65, 30)) * cast(T_FUN_SUM(t1.v1), DECIMAL(65, 30)) / cast(T_FUN_COUNT(t1.v1) * T_FUN_COUNT(t1.v1), DECIMAL(40, 0)), DOUBLE(-1, -1))]), filter(nil), 
      group(nil), agg_func([T_FUN_SUM(t1.v1)], [T_FUN_SUM(t1.v1 * t1.v1)], [T_FUN_COUNT(t1.v1)], [T_FUN_COUNT(t1.v1 * t1.v1)])
  1 - output([t1.v1]), filter(nil), 
      access([t1.v1]), partitions(p0)

select std(v1) from t1;
std(v1)
2.7856776554368237
select stddev(v1) from t1;
stddev(v1)
2.7856776554368237
select stddev_samp(v1) from t1;
stddev_samp(v1)
3.1144823004794873
select stddev_pop(v1) from t1;
stddev_pop(v1)
2.7856776554368237
select variance(v1) from t1;
variance(v1)
7.76
create table t_std as select std(v1) V from t1;
create table t_stddev as select stddev(v1) V from t1;
create table t_stddev_pop as select stddev_pop(v1) V from t1;
create table t_variance as select variance(v1) V from t1;
create table t_stddev_samp as select stddev_samp(v1) V from t1;
desc t_std;
Field   Type    Null    Key Default Extra
V       double  YES     NULL 
desc t_stddev;
Field   Type    Null    Key Default Extra
V       double  YES     NULL 
desc t_stddev_pop;
Field   Type    Null    Key Default Extra
V       double  YES     NULL 
desc t_variance;
Field   Type    Null    Key Default Extra
V       double  YES     NULL 
desc t_stddev_samp;
Field   Type    Null    Key Default Extra
V       double  YES     NULL 
create table t2(v1 int, v2 decimal(31,8), v3 double);
insert into t2 values(1,2.3,3.5),(2,3.2,4.7),(123,123.578,0.002);
insert into t2 values(1.22,2.98,3.5),(2.1,3.7,4.9),(173,113.558,0.001);
select std(v1), stddev(v1),stddev(v2),stddev(v3) from t2;
std(v1) stddev(v1) stddev(v2) stddev(v3)
70.55415571664712 70.55415571664712 54.53637502519662 2.027179355382471
select stddev_samp(v1),stddev_samp(v2),stddev_samp(v3) from t2;
stddev_samp(v1) stddev_samp(v2) stddev_samp(v3)
77.28820522347938 59.74160561172312 2.220663722103522
select stddev_pop(v1),stddev_pop(v2),stddev_pop(v3) from t2;
stddev_pop(v1) stddev_pop(v2) stddev_pop(v3)
70.55415571664712 54.53637502519662 2.027179355382471
select variance(v1),variance(v2),variance(v3) from t2;
variance(v1) variance(v2) variance(v3)
4977.888888888889 2974.2162008888895 4.10945613888889
select std(1) from dual;
std(1)
0
select stddev(1) from dual;
stddev(1)
0
select stddev_pop(1) from dual;
stddev_pop(1)
0
select stddev_samp(-1) from dual;
stddev_samp(-1)
NULL
select variance(-10) from dual;
variance(-10)
0
create table t3(v1 int);
insert into t3 values(0);
create table t_distribute(v1 int, v2 double, v3 decimal(20,7)) partition by hash(v1) partitions 4;
insert into t_distribute values(1, 2.111111111, 1233.3344444);
insert into t_distribute values(2, 2777.12, 3.3341242314444);
insert into t_distribute values(3, 55.112, 3.3343544444);
insert into t_distribute values(4, 233.3312, 3243.3344444);
insert into t_distribute values(5, 177.7712, 3.3899344444);
insert into t_distribute values(6, 999.1992, 7893.378143344444);
insert into t_distribute values(7, 277.7712, 156543.763344444);
insert into t_distribute values(8, 244.1992, 4643.4643344444);
insert into t_distribute values(9, 612.162, 46463.3446344444);
insert into t_distribute values(10, 223.312, 4643.34646344444);
insert into t_distribute values(11, 12.12, 79793.798793344444);
explain select stddev(v1) from t_distribute;
Query Plan
==========================================================
|ID|OPERATOR                 |NAME        |EST. ROWS|COST|
----------------------------------------------------------
|0 |SCALAR GROUP BY          |            |1        |185 |
|1 | PX COORDINATOR          |            |1        |185 |
|2 |  EXCHANGE OUT DISTR     |:EX10000    |1        |184 |
|3 |   MERGE GROUP BY        |            |1        |184 |
|4 |    PX PARTITION ITERATOR|            |8        |183 |
|5 |     TABLE SCAN          |t_distribute|8        |183 |
==========================================================

Outputs & filters: 
-------------------------------------
  0 - output([sqrt(cast(cast(T_FUN_SUM(T_FUN_SUM(t_distribute.v1 * t_distribute.v1)), DECIMAL(65, 30)) / cast(T_FUN_COUNT_SUM(T_FUN_COUNT(t_distribute.v1 * t_distribute.v1)), DECIMAL(20, 0)) - cast(T_FUN_SUM(T_FUN_SUM(t_distribute.v1)), DECIMAL(65, 30)) * cast(T_FUN_SUM(T_FUN_SUM(t_distribute.v1)), DECIMAL(65, 30)) / cast(T_FUN_COUNT_SUM(T_FUN_COUNT(t_distribute.v1)) * T_FUN_COUNT_SUM(T_FUN_COUNT(t_distribute.v1)), DECIMAL(40, 0)), DOUBLE(-1, -1)))]), filter(nil), 
      group(nil), agg_func([T_FUN_SUM(T_FUN_SUM(t_distribute.v1))], [T_FUN_SUM(T_FUN_SUM(t_distribute.v1 * t_distribute.v1))], [T_FUN_COUNT_SUM(T_FUN_COUNT(t_distribute.v1))], [T_FUN_COUNT_SUM(T_FUN_COUNT(t_distribute.v1 * t_distribute.v1))])
  1 - output([T_FUN_SUM(t_distribute.v1)], [T_FUN_SUM(t_distribute.v1 * t_distribute.v1)], [T_FUN_COUNT(t_distribute.v1)], [T_FUN_COUNT(t_distribute.v1 * t_distribute.v1)]), filter(nil)
  2 - output([T_FUN_SUM(t_distribute.v1)], [T_FUN_SUM(t_distribute.v1 * t_distribute.v1)], [T_FUN_COUNT(t_distribute.v1)], [T_FUN_COUNT(t_distribute.v1 * t_distribute.v1)]), filter(nil), dop=1
  3 - output([T_FUN_SUM(t_distribute.v1)], [T_FUN_SUM(t_distribute.v1 * t_distribute.v1)], [T_FUN_COUNT(t_distribute.v1)], [T_FUN_COUNT(t_distribute.v1 * t_distribute.v1)]), filter(nil), 
      group(nil), agg_func([T_FUN_SUM(t_distribute.v1)], [T_FUN_SUM(t_distribute.v1 * t_distribute.v1)], [T_FUN_COUNT(t_distribute.v1)], [T_FUN_COUNT(t_distribute.v1 * t_distribute.v1)])
  4 - output([t_distribute.v1]), filter(nil)
  5 - output([t_distribute.v1]), filter(nil), 
      access([t_distribute.v1]), partitions(p[0-3])

select std(v1), stddev(v1),stddev(v2),stddev(v3) from t_distribute;
std(v1) stddev(v1) stddev(v2) stddev(v3)
3.1622776601683795 3.1622776601683795 768.4716246220049 47407.305227945
select stddev_samp(v1),stddev_samp(v2),stddev_samp(v3) from t_distribute;
stddev_samp(v1) stddev_samp(v2) stddev_samp(v3)
3.3166247903554 805.97983947125 49721.2011909718
select stddev_pop(v1),stddev_pop(v2),stddev_pop(v3) from t_distribute;
stddev_pop(v1) stddev_pop(v2) stddev_pop(v3)
3.1622776601683795 768.4716246220049 47407.305227945
select variance(v1),variance(v2),variance(v3) from t_distribute;
variance(v1) variance(v2) variance(v3)
10 590548.6378491836 2247452588.975541
create table t_distinct(v1 int);
insert into t_distinct values(9);
insert into t_distinct values(10);
insert into t_distinct values(10);
insert into t_distinct values(10);
insert into t_distinct values(11);
insert into t_distinct values(12);
select stddev_samp(v1), stddev_samp(v1) from t_distinct;
stddev_samp(v1) stddev_samp(v1)
1.0327955589886444 1.0327955589886444
select stddev_pop(v1), stddev_pop(v1) from t_distinct;
stddev_pop(v1) stddev_pop(v1)
0.9428090415820634 0.9428090415820634
select std(v1) from t3;
std(v1)
0
select stddev(v1) from t3;
stddev(v1)
0
select stddev_samp(v1) from t3;
stddev_samp(v1)
NULL
select stddev_pop(v1) from t3;
stddev_pop(v1)
0
select variance(v1) from t3;
variance(v1)
0
DROP VIEW IF EXISTS V0;
CREATE VIEW v0 ( v1 ) AS SELECT ( 18 , 16 , 24 ) <=> ( 11 , 0 , 24 );
SELECT STDDEV_POP ( v1 ) FROM v0 WHERE v1 = 84 ;
STDDEV_POP ( v1 )
NULL
```
