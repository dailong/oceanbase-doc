# 新增一个 case

本文介绍如何新增 case 和 case 示例说明。

## 操作步骤

在通用的 t 目录下:

假设我们测试 create table like 这个功能，case 文件最好能反映测试点，比如create_table_like_syntax.test 为语法级别的测试。

1. 进入文件目录：

    ```bash
    cd oceanbase/tools/deploy/
    ```

2. 输入 case 文件的内容：

    ```bash
    vi mysqltest/t/sample.test
    ```

3. 生产结果文件：

    ```bash
    ./deploy.py ob1.mysqltest testset=sample record
    ```

4. 人工校验结果文件后（这步也可能通过执行与 MySQL 的对比来完成）:

    ```bash
    mv mysqltest/record/sample.record mysqltest/r/sample.result
    ```

    与 MySQL 对比的命令：

    ```bash
    ./deploy.py ob1.mysqltest testset=sample mysql=ip:port
    ```

    此时 MySQL 的文件生成在 `mysql_test/r/sample.result.my`，如果 MySQL 的结果文件可以直接作为结果文件，可以直接执行 `mv sample.result.my sample.result`。

5. 再运行检查一遍：

    ```bash
    ./deploy.py ob1.mysqltest testset=sample 
    ```

6. 提交时注意 git add 的时候要同时提交 test 文件和 result 文件。

## 示例

`ceil_dml_scenario_oracle - new.test` 主要目的是测试 ceil 函数在 DML和事务中的应用。下文是这个 case 的详细内容，其中井号（#）开头的行内容为备注说明。

```sql
#owner: 特性负责人
#owner group: 组别
#tags: dml
#description: ceil的insert, update, delete测试,事务
#ceil(n)
#author: 用例作者

--disable_warnings
--error 0,600
DROP TABLE tmp_table CASCADE CONSTRAINTS purge;
--error 0,600
DROP TABLE tmp2_table CASCADE CONSTRAINTS purge;
--error 0,1418
drop index t_tmp_idx_global_2;
--enable_warnings

###创建基础表、索引
#create table/index for dml
set session foreign_key_checks = 1;

create table tmp_table (c1 number, c2 float, c3 binary_double, c4 binary_float, c5 int, c6 smallint, c7 numeric, c8 dec, c9 decimal, c10 nvarchar2(1000), c11 varchar2(1000), constraint tmp_table_pk_test primary key(c1), constraint tmp_table_fk_test_test foreign key(c7) references tmp_table(c1), constraint tmp_table_unique_test unique(c3), constraint tmp_table_check_test check(ceil(c4) > 0)) pctfree 3  pctused 3 initrans 3  compress basic enable row movement partition by hash(c1);
create table tmp2_table (c1 number, c2 float, c3 binary_double, c4 binary_float, c5 int, c6 smallint, c7 numeric, c8 dec, c9 decimal, c10 nvarchar2(1000), c11 varchar2(1000), constraint tmp2_table_pk_test primary key(c1), constraint tmp_table2_fk_test_test foreign key(c7) references tmp2_table(c1), constraint tmp2_table_unique_test unique(c3), constraint tmp2_table_check_test check(ceil(c4) > 0)) pctfree 3  pctused 3 initrans 3  compress basic enable row movement partition by hash(c1);

create index t_tmp_idx_global_2 on tmp_table(ceil(c1),ceil(c2),ceil(c5)) global;

###插入测试，应用ceil函数
#insert test
insert into tmp_table values(ceil(1.2344545454e3), ceil(3.3434343),ceil(1.23234545454e4d), ceil(1.34343343e5f),ceil(7899.104),ceil(23),ceil(1.2344545454e3), ceil(66666),ceil(123445.54565), ceil(111.44444),ceil(2322.44545));
insert into tmp_table(c1,c3,c4,c7) values(ceil(199.2344545454e3),ceil(29d),ceil(1.34343343e5f),ceil(1.2344545454e3));

###插入测试，应用ceil函数
## insert select 
set session foreign_key_checks = 0;
--error 600
insert into tmp2_table(c1,c3,c4,c7) select ceil(c1),ceil(c3),ceil(c4),ceil(c7) from tmp_table;
set session foreign_key_checks = 1;

insert into tmp2_table values(ceil(9.999999e10), ceil(9.999999e100),ceil(9.9999e307d), ceil(9.999e37f), ceil(9999999999999999999999999999999999999),ceil(9999999999999999999999999999999999999),ceil(9.999999e10),ceil(9.999999e100),ceil(9.999999e10),ceil(9.999999e100),ceil(9.999999e100));

###更新测试，应用ceil函数
#update test
update tmp_table set c1 = ceil(c1), c2 = ceil(c2), c3 = ceil(c3), c4 = ceil(c4), c5 = ceil(c5), c6 = ceil(c6), c7 = ceil(c7), c8 = ceil(c8), c9 = ceil(c9), c10 = ceil(c10), c11 = ceil(c11);

update tmp_table set c1 = ceil(c1), c2 = ceil(c2), c3 = ceil(c3), c4 = ceil(c4), c5 = ceil(c5), c6 = ceil(c6), c7 = ceil(c7), c8 = ceil(c8), c9 = ceil(c9), c10 = ceil(c10), c11 = ceil(c11) where c1 = ceil(1.2344545454e3);

update tmp2_table set (c3,c4) = (select ceil(c3) + 0.1,ceil(c4) + 0.1 from tmp_table where c1 = ceil(1.2344545454e3) ) where c1 = ceil(1.2344545454e3);

select * from tmp_table order by c1;
select * from tmp2_table order by c1;

###merge into测试，应用ceil函数
#merge into test
--error 918
merge into tmp_table t1 using tmp2_table t2 on (t1.c1 = t2.c1) WHEN MATCHED THEN UPDATE SET t1.c2 = ceil(t2.c2), t1.c3 = ceil(t2.c3), t1.c4 = ceil(t2.c4), t1.c5 = ceil(t2.c5), t1.c6 = ceil(t2.c6),  c8 = ceil(t2.c8), t1.c9 = ceil(t2.c9), t1.c10 = ceil(t1.c10), t1.c11 = ceil(t2.c11) WHEN NOT MATCHED THEN insert (c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11) values(ceil(t2.c1),ceil(t2.c2),ceil(t2.c3),ceil(t2.c4),ceil(t2.c5),ceil(t2.c6),ceil(t2.c7),ceil(t2.c8),ceil(t2.c9),ceil(t2.c10),ceil(t2.c11));

merge into tmp_table t1 using tmp2_table t2 on (t1.c1 = t2.c1) WHEN MATCHED THEN UPDATE SET t1.c2 = ceil(t2.c2), t1.c3 = ceil(t2.c3), t1.c4 = ceil(t2.c4), t1.c5 = ceil(t2.c5), t1.c6 = ceil(t2.c6),  t1.c8 = ceil(t2.c8), t1.c9 = ceil(t2.c9), t1.c10 = ceil(t1.c10), t1.c11 = ceil(t2.c11) WHEN NOT MATCHED THEN insert (t1.c1,t1.c2,t1.c3,t1.c4,t1.c5,t1.c6,t1.c7,t1.c8,t1.c9,t1.c10,t1.c11) values(ceil(t2.c1),ceil(t2.c2),ceil(t2.c3),ceil(t2.c4),ceil(t2.c5),ceil(t2.c6),ceil(t2.c7),ceil(t2.c8),ceil(t2.c9),ceil(t2.c10),ceil(t2.c11));

###删除测试，应用ceil函数
#delete
set session foreign_key_checks = 0;
delete from tmp2_table where ceil(c1) > 2;
set session foreign_key_checks = 1;

commit;

###事务中，应用ceil函数
#事务
set session autocommit = 0;
truncate table tmp_table;
insert into tmp_table values(ceil(1.2344545454e3), ceil(3.3434343),ceil(1.23234545454e4d), ceil(1.34343343e5f),ceil(7899.104),ceil(23),ceil(1.2344545454e3), ceil(66666),ceil(123445.54565), ceil(111.44444),ceil(2322.44545));
insert into tmp_table(c1,c3,c4,c7) values(ceil(199.2344545454e3),ceil(29d),ceil(1.34343343e5f),ceil(1.2344545454e3));
insert into tmp_table values(0, 0,0, 0.12333,0,0,ceil(1.2344545454e3),0,0, 0,0);
commit;
select * from tmp_table order by c1;
select ceil(c1),ceil(c2),ceil(c3),ceil(c4),ceil(c5),ceil(c6),ceil(c7),ceil(c8),ceil(c9),ceil(c10),ceil(c11) from tmp_table order by c1;
select * from tmp_table order by c1;
rollback;
select * from tmp_table order by c1;
select ceil(c1),ceil(c2),ceil(c3),ceil(c4),ceil(c5),ceil(c6),ceil(c7),ceil(c8),ceil(c9),ceil(c10),ceil(c11) from tmp_table order by c1;
select * from tmp_table order by c1;

--error 2290
update tmp_table set c1 = ceil(9.999e1) where c2 = 0;
select * from tmp_table order by c1,c2,c3,c4,c5;
savepoint a1;

--error 2290
update tmp_table set c1 = ceil(8.8888888e1) where c2 = 0;
select * from tmp_table order by c1,c2,c3,c4,c5;
savepoint a2;

--error 2290
update tmp_table set c1 = ceil(77.7777e1) where c2 = 0;
select * from tmp_table order by c1,c2,c3,c4,c5;
savepoint a3;

###回滚
rollback to a2;
select * from tmp_table order by c1,c2,c3,c4,c5;
commit;
set session autocommit = 1;

###清理测试环境，删除表和索引。
--disable_warnings
--error 0,600
DROP TABLE tmp_table CASCADE CONSTRAINTS purge;
--error 0,600
DROP TABLE tmp2_table CASCADE CONSTRAINTS purge;
--error 0,1418
drop index t_tmp_idx_global_2;
--enable_warnings
```
